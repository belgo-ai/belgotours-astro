---

// Componente de Asistente IA - UX Premium BelgoTours
export interface Props {
  tourId: string;
  tourName: string;
  lang: "es" | "en" | "it" | "fr";
  ciudad: "bruselas" | "brujas";
  tipo: "free" | "privado" | "especial";
}

const { tourId, tourName, lang, ciudad, tipo } = Astro.props;

// Textos UI por idioma (para que NO quede en espaÃ±ol)
const UI = {
  es: {
    title: "BelgoAI Assistant",
    subtitlePrefix: "Para",
    hello: `Â¡Hola! Soy tu asistente para el ${tourName}. Â¿En quÃ© puedo ayudarte?`,
    placeholder: "Escribe tu preguntaâ€¦",
    quick1: "ğŸ“ Punto de encuentro",
    quick2: "â±ï¸ DuraciÃ³n y horarios",
    quick3: "ğŸ’ QuÃ© llevar al tour",
    q1: "Â¿DÃ³nde es el punto de encuentro?",
    q2: "Â¿CuÃ¡nto dura el tour?",
    q3: "Â¿QuÃ© debo llevar?",
  },
  en: {
    title: "BelgoAI Assistant",
    subtitlePrefix: "For",
    hello: `Hi! I'm your assistant for ${tourName}. How can I help?`,
    placeholder: "Type your questionâ€¦",
    quick1: "ğŸ“ Meeting point",
    quick2: "â±ï¸ Duration & schedule",
    quick3: "ğŸ’ What to bring",
    q1: "Where is the meeting point?",
    q2: "How long does the tour last?",
    q3: "What should I bring?",
  },
  it: {
    title: "BelgoAI Assistant",
    subtitlePrefix: "Per",
    hello: `Ciao! Sono il tuo assistente per ${tourName}. Come posso aiutarti?`,
    placeholder: "Scrivi la tua domandaâ€¦",
    quick1: "ğŸ“ Punto dâ€™incontro",
    quick2: "â±ï¸ Durata e orari",
    quick3: "ğŸ’ Cosa portare",
    q1: "Dovâ€™Ã¨ il punto dâ€™incontro?",
    q2: "Quanto dura il tour?",
    q3: "Cosa dovrei portare?",
  },
  fr: {
    title: "BelgoAI Assistant",
    subtitlePrefix: "Pour",
    hello: `Bonjour ! Je suis ton assistant pour ${tourName}. Comment puis-je aider ?`,
    placeholder: "Ã‰cris ta questionâ€¦",
    quick1: "ğŸ“ Point de rencontre",
    quick2: "â±ï¸ DurÃ©e et horaires",
    quick3: "ğŸ’ Quoi apporter",
    q1: "OÃ¹ est le point de rencontre ?",
    q2: "Combien de temps dure le tour ?",
    q3: "Que dois-je apporter ?",
  },
};

const t = UI[lang] || UI.es;

---

<div
  id="aiAssistant"
  data-lang={lang}
  data-ciudad={ciudad}
  data-tipo={tipo}
  data-tour-id={tourId}
  data-tour-name={tourName}
  class="fixed bottom-28 right-6 z-40 transition-all duration-300"
>

  <!-- BotÃ³n flotante -->
  <button 
    id="aiAssistantButton"
    aria-label="Asistente del tour"
    class="bg-black text-[#FACC15]
           w-14 h-14 rounded-full
           shadow-2xl
           flex items-center justify-center
           transition-all duration-300
           hover:scale-110 hover:bg-gray-900"
  >
    <span class="text-xl">ğŸ¤–</span>
  </button>

  <!-- Chat Container -->
  <div
    id="aiChatContainer"
    class="hidden fixed bottom-44 right-6
           w-80 h-96
           bg-white rounded-2xl
           shadow-2xl border border-gray-200
           z-50 flex flex-col"
  >
    <!-- Header -->
    <div class="bg-black text-[#FACC15] p-4 rounded-t-2xl flex-shrink-0">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-lg">ğŸ¤–</span>
          <div>
            <h3 class="font-bold text-sm text-white">BelgoAI Assistant</h3>
            <p class="text-xs text-yellow-300">{t.subtitlePrefix} {tourName}</p>
          </div>
        </div>
        <button
          id="closeChatButton"
          class="text-[#FACC15] hover:text-yellow-300 text-lg"
          aria-label="Cerrar chat"
        >
          Ã—
        </button>
      </div>
    </div>

    <!-- Chat Messages -->
    <div id="aiChatMessages" class="flex-1 p-4 overflow-y-auto bg-gray-50">
      <div class="ai-message bot-message mb-4">
        <div class="bg-white rounded-lg p-3 shadow-sm border">
          <p class="text-sm text-gray-700">
  {t.hello}
</p>


          <div class="mt-3 space-y-1">
            <button
              class="quick-question-btn block w-full text-left text-xs
                     text-gray-800 hover:text-black
                     p-2 rounded hover:bg-gray-100"
              data-question={t.q1}
            >
              {t.quick1}
            </button>

            <button
              class="quick-question-btn block w-full text-left text-xs
                     text-gray-800 hover:text-black
                     p-2 rounded hover:bg-gray-100"
              data-question={t.q2}
            >
              {t.quick2}
            </button>

            <button
              class="quick-question-btn block w-full text-left text-xs
                     text-gray-800 hover:text-black
                     p-2 rounded hover:bg-gray-100"
              data-question={t.q3}
            >
             {t.quick3}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="p-3 border-t border-gray-200 flex-shrink-0">
      <div class="flex gap-2">
        <input 
          type="text"
          id="aiChatInput"
          placeholder={t.placeholder}
          class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm
                 focus:ring-2 focus:ring-[#FACC15] focus:border-transparent"
        />
        <button 
          id="sendMessageButton"
          class="bg-black text-[#FACC15]
                 px-3 py-2 rounded-lg text-sm
                 hover:bg-gray-900 transition
                 flex items-center justify-center w-10"
          aria-label="Enviar mensaje"
        >
          â†’
        </button>
      </div>
    </div>
  </div>
</div>

<script is:inline>
const root = document.getElementById("aiAssistant");

const __AI_CTX__ = root ? {
  lang: root.dataset.lang,
  ciudad: root.dataset.ciudad,
  tipo: root.dataset.tipo,
  tourId: root.dataset.tourId,
  tourName: root.dataset.tourName
} : null;

function initAiAssistant() {
  if (!__AI_CTX__) return;

  const btn = document.getElementById("aiAssistantButton");
  const chat = document.getElementById("aiChatContainer");
  const closeBtn = document.getElementById("closeChatButton");
  const messages = document.getElementById("aiChatMessages");
  const input = document.getElementById("aiChatInput");
  const sendBtn = document.getElementById("sendMessageButton");

  if (!btn || !chat || !messages || !input || !sendBtn) return;

  // --- Knowledge base por idioma/ciudad/tipo ---
  const AI_KNOWLEDGE = {
    es: {
      bruselas: {
        free: {
          meeting: "ğŸ“ El punto de encuentro exacto estÃ¡ en la secciÃ³n de mapa del tour.",
          duration: "â±ï¸ En promedio dura 2â€“2.5 horas.",
          bring: "ğŸ’ Calzado cÃ³modo, agua y ropa segÃºn el clima.",
          default: "ğŸ¤– Puedo ayudarte con horarios, punto de encuentro o recomendaciones."
        }
      },
      brujas: {
        free: {
          meeting: "ğŸ“ El punto de encuentro se indica tras la reserva (secciÃ³n de mapa).",
          duration: "â±ï¸ En promedio dura cerca de 2 horas.",
          bring: "ğŸ’ Calzado cÃ³modo y cÃ¡mara: Brujas es preciosa para fotos.",
          default: "ğŸ¤– Puedo ayudarte con detalles del Free Tour en Brujas."
        }
      }
    },

    en: {
      bruselas: {
        free: {
          meeting: "ğŸ“ The exact meeting point is in the map section of the tour.",
          duration: "â±ï¸ It usually lasts around 2â€“2.5 hours.",
          bring: "ğŸ’ Comfortable shoes, water, and weather-appropriate clothing.",
          default: "ğŸ¤– I can help with meeting point, schedule, and tips."
        }
      }
    },

    it: {
      bruselas: {
        free: {
          meeting: "ğŸ“ Il punto di incontro Ã¨ indicato nella sezione mappa del tour.",
          duration: "â±ï¸ Di solito dura 2â€“2,5 ore.",
          bring: "ğŸ’ Scarpe comode, acqua e abbigliamento adeguato al meteo.",
          default: "ğŸ¤– Posso aiutarti con punto dâ€™incontro, orari e consigli."
        }
      }
    },

    fr: {
      bruselas: {
        free: {
          meeting: "ğŸ“ Le point de rencontre exact est dans la section carte du tour.",
          duration: "â±ï¸ En gÃ©nÃ©ral, Ã§a dure 2â€“2h30.",
          bring: "ğŸ’ Chaussures confortables, eau, et vÃªtements selon la mÃ©tÃ©o.",
          default: "ğŸ¤– Je peux aider avec le point de rencontre, les horaires et des conseils."
        }
      }
    }
  };

  function getKnowledge() {
    const { lang, ciudad, tipo } = __AI_CTX__;
    return (
      AI_KNOWLEDGE?.[lang]?.[ciudad]?.[tipo] ||
      AI_KNOWLEDGE?.[lang]?.[ciudad]?.free ||
      AI_KNOWLEDGE?.es?.bruselas?.free
    );
  }

  function aiReply(question) {
  const kb = getKnowledge();
  const q = question.toLowerCase();
  const lang = __AI_CTX__.lang;

  const keywords = {
    es: {
      meeting: ["punto", "encuentro"],
      duration: ["dur", "tiempo"],
      bring: ["llevar", "traer"]
    },
    en: {
      meeting: ["meeting"],
      duration: ["duration", "long"],
      bring: ["bring"]
    },
    it: {
      meeting: ["incontro"],
      duration: ["durata"],
      bring: ["portare"]
    },
    fr: {
      meeting: ["rencontre"],
      duration: ["durÃ©e"],
      bring: ["apporter"]
    }
  };

  const k = keywords[lang] || keywords.es;

  if (k.meeting.some(w => q.includes(w))) return kb.meeting;
  if (k.duration.some(w => q.includes(w))) return kb.duration;
  if (k.bring.some(w => q.includes(w))) return kb.bring;

  return kb.default;
}

  function sendMessage(text, from = "user") {
    const wrapper = document.createElement("div");
    wrapper.className = `ai-message mb-3 ${from === "user" ? "text-right" : ""}`;

    wrapper.innerHTML = `
      <div class="inline-block max-w-[85%] rounded-lg px-3 py-2 text-sm shadow
        ${from === "user" ? "bg-black text-white" : "bg-white border text-gray-700"}">
        ${text}
      </div>
    `;

    messages.appendChild(wrapper);
    messages.scrollTop = messages.scrollHeight;
  }

  // Abrir / cerrar
  btn.addEventListener("click", () => {
    chat.classList.toggle("hidden");
    setTimeout(() => input.focus(), 0);
  });

  closeBtn?.addEventListener("click", () => {
    chat.classList.add("hidden");
  });

  // Enviar
  sendBtn.addEventListener("click", () => {
    const text = input.value.trim();
    if (!text) return;

    sendMessage(text, "user");
    input.value = "";

    setTimeout(() => {
      sendMessage(aiReply(text), "bot");
    }, 250);
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendBtn.click();
  });

  // Preguntas rÃ¡pidas
  document.querySelectorAll(".quick-question-btn").forEach((b) => {
    b.addEventListener("click", () => {
      const q = b.getAttribute("data-question");
      if (!q) return;
      sendMessage(q, "user");
      setTimeout(() => sendMessage(aiReply(q), "bot"), 250);
    });
  });
}

// âœ… Astro Island: ejecutar aunque DOMContentLoaded ya haya pasado
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initAiAssistant);
} else {
  initAiAssistant();
}

</script>

<style>

.ai-message {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

#aiChatMessages {
  scrollbar-width: thin;
  scrollbar-color: #cbd5e0 #f7fafc;
}

#aiChatMessages::-webkit-scrollbar {
  width: 6px;
}

#aiChatMessages::-webkit-scrollbar-track {
  background: #f7fafc;
  border-radius: 3px;
}

#aiChatMessages::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 3px;
}

/* Mobile: siempre separado del CTA */
@media (max-width: 768px) {
  #aiAssistant {
    bottom: 96px !important;
    right: 16px !important;
  }

  #aiChatContainer {
    width: 90vw !important;
    left: 5vw !important;
    right: 5vw !important;
    bottom: 140px !important;
  }
}
</style>
